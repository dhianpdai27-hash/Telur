<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Penjualan Telur â€“ Bumdes Campurejo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    .tab-content { display: none; }
    .active-tab { display: block; }
  </style>
</head>

<body class="bg-gray-100 font-sans">
<div class="max-w-6xl mx-auto p-4">
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
      <div>
        <h1 class="text-2xl font-black text-gray-800 tracking-tight">ğŸ¥š BUMDES CAMPUREJO</h1>
        <p class="text-[10px] text-green-600 uppercase tracking-[0.2em] font-bold">Sukses Mandiri</p>
      </div>
      <nav class="flex gap-2 mt-4 md:mt-0 bg-gray-100 p-1 rounded-xl">
          <button onclick="showTab('transaksi')" class="px-5 py-2 hover:bg-white rounded-lg text-sm font-bold transition-all">Input</button>
          <button onclick="showTab('riwayat')" class="px-5 py-2 hover:bg-white rounded-lg text-sm font-bold transition-all">Riwayat</button>
          <button onclick="showTab('laporan')" class="px-5 py-2 hover:bg-white rounded-lg text-sm font-bold transition-all">Laporan</button>
          <button onclick="showTab('pengaturan')" class="px-5 py-2 hover:bg-white rounded-lg text-sm font-bold transition-all">âš™ï¸</button>
      </nav>
  </div>

  <div id="transaksi" class="tab-content active-tab">
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
      <h2 id="formTitle" class="text-xl font-bold mb-6 text-gray-700 border-l-4 border-green-500 pl-4">Transaksi Baru</h2>
      <form id="salesForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <input id="customerName" required placeholder="Nama Pembeli" class="bg-gray-50 border-2 border-transparent focus:border-green-500 p-3 rounded-xl outline-none transition">
        <input id="staffName" required placeholder="Petugas" class="bg-gray-50 border-2 border-transparent focus:border-green-500 p-3 rounded-xl outline-none transition">
        <input id="eggWeight" type="number" step="0.01" required placeholder="Berat (kg)" class="bg-gray-50 border-2 border-transparent focus:border-green-500 p-3 rounded-xl outline-none transition font-bold text-lg">
        <input id="pricePerKg" type="number" required placeholder="Harga per kg" class="bg-gray-50 border-2 border-transparent focus:border-green-500 p-3 rounded-xl outline-none transition font-bold text-lg">
        <div class="md:col-span-2 bg-green-50 p-6 rounded-2xl border-2 border-green-100 text-center">
            <span class="text-xs font-bold text-green-600 uppercase block mb-1 tracking-widest">Total Bayar</span>
            <input id="totalAmount" readonly class="bg-transparent text-4xl font-black text-green-700 text-center w-full outline-none">
        </div>
        <button type="submit" id="btnSubmit" class="md:col-span-2 bg-green-600 hover:bg-green-700 text-white p-4 rounded-xl font-black shadow-lg shadow-green-200 transition-all active:scale-95">ğŸ’¾ SIMPAN & CETAK STRUK</button>
      </form>
    </div>
  </div>

  <div id="riwayat" class="tab-content">
    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
      <h2 class="text-lg font-bold mb-4">ğŸ“œ Riwayat Transaksi</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="bg-gray-50 text-gray-500 uppercase text-[10px] font-bold">
            <tr>
              <th class="p-4 border-b">Tgl/Jam</th>
              <th class="p-4 border-b">Pembeli</th>
              <th class="p-4 border-b">Berat</th>
              <th class="p-4 border-b">Total</th>
              <th class="p-4 border-b text-center">Aksi</th>
            </tr>
          </thead>
          <tbody id="historyTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="laporan" class="tab-content">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-green-500">
            <h3 class="font-bold mb-4 text-gray-700">Laporan Harian</h3>
            <input type="date" id="reportDate" class="w-full border p-2 mb-3 rounded-lg outline-none">
            <button onclick="generatePDF('harian')" class="w-full bg-green-600 text-white p-3 rounded-xl font-bold">ğŸ“„ Download PDF</button>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-blue-500">
            <h3 class="font-bold mb-4 text-gray-700">Laporan Mingguan</h3>
            <button onclick="generatePDF('mingguan')" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold">ğŸ“„ Download PDF</button>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-purple-500">
            <h3 class="font-bold mb-4 text-gray-700">Laporan Bulanan</h3>
            <button onclick="generatePDF('bulanan')" class="w-full bg-purple-600 text-white p-3 rounded-xl font-bold">ğŸ“„ Download PDF</button>
        </div>
    </div>
  </div>

  <div id="pengaturan" class="tab-content">
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100 max-w-md mx-auto">
      <h2 class="text-lg font-bold mb-6 text-center text-gray-700 border-b pb-2">âš™ï¸ Manajemen Data</h2>
      <div class="space-y-4">
          <div>
              <label class="text-xs font-bold text-gray-500 uppercase">Salin Data (Backup)</label>
              <button onclick="exportData()" class="w-full mt-1 bg-blue-500 text-white p-3 rounded-xl font-bold hover:bg-blue-600 transition">ğŸ“¤ Backup ke File .json</button>
          </div>
          <hr>
          <div>
              <label class="text-xs font-bold text-gray-500 uppercase">Masukkan Data (Import)</label>
              <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(event)">
              <button onclick="document.getElementById('importFile').click()" class="w-full mt-1 bg-orange-500 text-white p-3 rounded-xl font-bold hover:bg-orange-600 transition">ğŸ“¥ Pilih File Backup</button>
          </div>
          <hr>
          <div>
              <label class="text-xs font-bold text-gray-400 uppercase">Hapus Permanen</label>
              <button onclick="resetData()" class="w-full mt-1 bg-red-50 text-red-600 p-3 rounded-xl font-bold hover:bg-red-100 transition">âš ï¸ Kosongkan Semua Data</button>
          </div>
      </div>
    </div>
  </div>
</div>

<script>
let transactions = JSON.parse(localStorage.getItem('eggTransactions')) || [];
let editId = null; // Menyimpan ID data yang sedang diedit

const weightInput = document.getElementById('eggWeight');
const priceInput = document.getElementById('pricePerKg');
const totalInput = document.getElementById('totalAmount');

[weightInput, priceInput].forEach(el => {
    el.addEventListener('input', () => {
        const w = parseFloat(weightInput.value) || 0;
        const p = parseFloat(priceInput.value) || 0;
        totalInput.value = 'Rp ' + (w * p).toLocaleString('id-ID');
    });
});

document.getElementById('salesForm').addEventListener('submit', (e) => {
  e.preventDefault();
  
  // Jika sedang mode edit, hapus data lama dulu berdasarkan ID
  if (editId) {
      transactions = transactions.filter(t => t.id !== editId);
      editId = null;
      document.getElementById('formTitle').innerText = "Transaksi Baru";
      document.getElementById('formTitle').classList.replace('border-orange-500', 'border-green-500');
  }

  const now = new Date();
  const trx = {
    id: Date.now(),
    notaNo: 'INV' + Math.floor(1000 + Math.random() * 8999),
    date: now.toLocaleDateString('id-ID'),
    isoDate: now.toISOString().split('T')[0],
    time: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
    customer: document.getElementById('customerName').value,
    staff: document.getElementById('staffName').value,
    weight: parseFloat(weightInput.value),
    price: parseFloat(priceInput.value),
    total: parseFloat(weightInput.value) * parseFloat(priceInput.value)
  };
  
  transactions.push(trx);
  localStorage.setItem('eggTransactions', JSON.stringify(transactions));
  printRawBT(trx); 
  e.target.reset();
  totalInput.value = '';
});

function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active-tab'));
    document.getElementById(tabId).classList.add('active-tab');
    if(tabId === 'riwayat') updateHistoryTable();
}

function updateHistoryTable() {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = '';
    transactions.slice().reverse().forEach(t => {
        tbody.innerHTML += `
            <tr class="hover:bg-gray-50 border-b">
                <td class="p-4 text-[11px]">${t.date} ${t.time}</td>
                <td class="p-4 font-bold">${t.customer}</td>
                <td class="p-4">${t.weight} kg</td>
                <td class="p-4 font-black text-green-700">Rp ${t.total.toLocaleString('id-ID')}</td>
                <td class="p-4 flex gap-2 justify-center">
                    <button onclick='printRawBT(${JSON.stringify(t)})' class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-[10px] font-bold uppercase">Struk</button>
                    <button onclick='editTransaction(${t.id})' class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-[10px] font-bold uppercase">Edit</button>
                    <button onclick='deleteTransaction(${t.id})' class="bg-red-100 text-red-700 px-2 py-1 rounded text-[10px] font-bold uppercase">Hapus</button>
                </td>
            </tr>
        `;
    });
}

// FUNGSI EDIT: Mengisi kembali form input
function editTransaction(id) {
    const t = transactions.find(item => item.id === id);
    if (t) {
        editId = t.id;
        document.getElementById('customerName').value = t.customer;
        document.getElementById('staffName').value = t.staff;
        document.getElementById('eggWeight').value = t.weight;
        document.getElementById('pricePerKg').value = t.price;
        totalInput.value = 'Rp ' + t.total.toLocaleString('id-ID');
        
        document.getElementById('formTitle').innerText = "Edit Transaksi (Mode Edit)";
        document.getElementById('formTitle').classList.replace('border-green-500', 'border-orange-500');
        showTab('transaksi');
        window.scrollTo(0,0);
    }
}

// FUNGSI HAPUS SATUAN
function deleteTransaction(id) {
    if (confirm("Hapus data transaksi ini dari riwayat?")) {
        transactions = transactions.filter(t => t.id !== id);
        localStorage.setItem('eggTransactions', JSON.stringify(transactions));
        updateHistoryTable();
    }
}

function printRawBT(t) {
    let struk = 
        "------------------------------\n" +
        "       BUMDES CAMPUREJO       \n" +
        "        SUKSES MANDIRI        \n" +
        "------------------------------\n" +
        "Nota  : " + t.notaNo + "\n" +
        "Tgl   : " + t.date + " " + t.time + "\n" +
        "Plgn  : " + t.customer + "\n" +
        "Ksr   : " + t.staff + "\n" +
        "------------------------------\n" +
        "Telur Ayam   " + t.weight + "kg\n" +
        "Harga/kg     Rp " + t.price.toLocaleString('id-ID') + "\n" +
        "------------------------------\n" +
        "TOTAL        Rp " + t.total.toLocaleString('id-ID') + "\n" +
        "------------------------------\n" +
        "   Terima Kasih Atas\n" +
        "   Kepercayaan Anda\n\n\n\n";
    window.location.href = "rawbt:base64," + btoa(struk);
}

function generatePDF(tipe) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const now = new Date();
    let filteredData = [];
    let title = "";

    if (tipe === 'harian') {
        const d = document.getElementById('reportDate').value;
        if (!d) return alert("Pilih tanggal!");
        filteredData = transactions.filter(t => t.isoDate === d);
        title = "LAPORAN HARIAN - " + d;
    } else if (tipe === 'mingguan') {
        const lastWeek = new Date(now.setDate(now.getDate() - 7));
        filteredData = transactions.filter(t => new Date(t.isoDate) >= lastWeek);
        title = "LAPORAN MINGGUAN (7 HARI TERAKHIR)";
    } else if (tipe === 'bulanan') {
        filteredData = transactions.filter(t => {
            const d = new Date(t.isoDate);
            return d.getMonth() === new Date().getMonth() && d.getFullYear() === new Date().getFullYear();
        });
        title = "LAPORAN BULANAN";
    }

    if (filteredData.length === 0) return alert("Data kosong.");

    doc.text("BUMDES CAMPUREJO", 105, 15, { align: "center" });
    doc.text(title, 105, 22, { align: "center" });
    const rows = filteredData.map(t => [t.date, t.customer, t.weight + " kg", "Rp " + t.total.toLocaleString('id-ID')]);
    doc.autoTable({ head: [['Tanggal', 'Pelanggan', 'Berat', 'Total']], body: rows, startY: 30 });
    const totalOmzet = filteredData.reduce((s, t) => s + t.total, 0);
    doc.text("Total Omzet: Rp " + totalOmzet.toLocaleString('id-ID'), 14, doc.lastAutoTable.finalY + 10);
    doc.save(`Laporan_${tipe}.pdf`);
}

function exportData() {
    const blob = new Blob([JSON.stringify(transactions)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'backup_kasir_telur.json';
    a.click();
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            if (Array.isArray(importedData)) {
                if (confirm(`Impor ${importedData.length} data?`)) {
                    transactions = [...transactions, ...importedData];
                    transactions = Array.from(new Set(transactions.map(a => a.id))).map(id => transactions.find(a => a.id === id));
                    localStorage.setItem('eggTransactions', JSON.stringify(transactions));
                    alert("Data berhasil diimpor!");
                    updateHistoryTable();
                }
            }
        } catch (err) { alert("Gagal impor."); }
    };
    reader.readAsText(file);
}

function resetData() {
    if(confirm('Hapus semua data permanen?')) {
        localStorage.clear();
        transactions = [];
        location.reload();
    }
}
</script>
</body>
</html>
