<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BUMDes MANDIRI - Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f1f5f9; padding-bottom: 90px; }
        .app-card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .tab { display: none; }
        .tab.active { display: block; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; border-top: 1px solid #ddd; height: 75px; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; font-weight: bold; color: #666; border: none; background: none; }
        .nav-item.active { color: #2563eb; }
    </style>
</head>
<body>

<div class="p-3">
    <div class="bg-dark text-white p-4 rounded-4 mb-4 shadow">
        <h4 class="fw-black mb-0 text-info">BUMDes MANDIRI</h4>
        <small id="tgl-info"></small>
        <hr class="opacity-25">
        <div class="d-flex justify-content-between">
            <small>Saldo Bersih:</small>
            <h5 id="dash-saldo" class="text-warning fw-bold">Rp 0</h5>
        </div>
    </div>

    <div id="tab-kasir" class="tab active">
        <div class="app-card">
            <label class="small fw-bold text-muted">NAMA ADMIN</label>
            <input type="text" id="admin" class="form-control mb-2" placeholder="Petugas">
            <div class="row g-2">
                <div class="col-6">
                    <label class="small fw-bold text-muted">BERAT (KG)</label>
                    <input type="number" id="berat" class="form-control" placeholder="0.0" oninput="hitung()">
                </div>
                <div class="col-6">
                    <label class="small fw-bold text-muted">HARGA (RP)</label>
                    <input type="number" id="harga" class="form-control" placeholder="25000" oninput="hitung()">
                </div>
            </div>
        </div>
        <div class="app-card bg-primary text-white text-center">
            <small class="opacity-75">TOTAL BAYAR</small>
            <h2 id="total-display" class="fw-black">Rp 0</h2>
        </div>
        <button onclick="simpanTrx()" class="btn btn-dark w-100 py-3 fw-bold shadow">SIMPAN & CETAK NOTA</button>
    </div>

    <div id="tab-biaya" class="tab">
        <div class="app-card border-start border-danger border-4">
            <h6 class="fw-bold text-danger">INPUT PENGELUARAN</h6>
            <input type="text" id="ket-biaya" class="form-control mb-2" placeholder="Keterangan">
            <input type="number" id="nom-biaya" class="form-control mb-3" placeholder="Nominal Rp">
            <button onclick="simpanBiaya()" class="btn btn-danger w-100 fw-bold">SIMPAN BIAYA</button>
        </div>
        <h6 class="fw-bold small text-muted px-2">DAFTAR PENGELUARAN</h6>
        <div id="list-biaya-full"></div>
    </div>

    <div id="tab-riwayat" class="tab">
        <h6 class="fw-bold small text-muted px-2">RIWAYAT TRANSAKSI</h6>
        <div id="list-riwayat"></div>
    </div>

    <div id="tab-laporan" class="tab">
        <div class="app-card border-top border-dark border-4">
            <h6 class="fw-bold">LAPORAN HARIAN</h6>
            <input type="date" id="tgl-lap" class="form-control mb-2" onchange="updateLaporan()">
            <div id="res-harian" class="p-2 bg-light rounded small fw-bold my-2">Pilih Tanggal</div>
            <button onclick="cetakLap('Harian')" class="btn btn-dark btn-sm w-100">CETAK HARIAN</button>
        </div>
        <div class="app-card border-top border-primary border-4">
            <h6 class="fw-bold">LAPORAN BULANAN</h6>
            <input type="month" id="bln-lap" class="form-control mb-2" onchange="updateLaporan()">
            <div id="res-bulanan" class="p-2 bg-light rounded small fw-bold my-2 text-primary">Pilih Bulan</div>
            <button onclick="cetakLap('Bulanan')" class="btn btn-primary btn-sm w-100">CETAK BULANAN</button>
        </div>
    </div>

    <div id="tab-opsi" class="tab">
        <div class="app-card text-center">
            <button onclick="exportExcel()" class="btn btn-success w-100 py-3 fw-bold mb-4">BACKUP KE EXCEL</button>
            <div class="border-top pt-3 border-secondary border-dashed">
                <p class="small fw-bold text-muted">RESTORE / IMPORT DATA</p>
                <input type="file" id="file-import" class="form-control mb-2">
                <button onclick="importExcel()" class="btn btn-outline-secondary btn-sm w-100 fw-bold">PROSES IMPORT DATA</button>
            </div>
        </div>
        <div class="text-center mt-5">
            <button onclick="resetData()" class="btn btn-link text-danger text-decoration-none fw-bold small opacity-25">RESET SEMUA DATA</button>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="nav('kasir', this)">üõí KASIR</button>
    <button class="nav-item" onclick="nav('biaya', this)">üí∏ BIAYA</button>
    <button class="nav-item" onclick="nav('riwayat', this)">üìã RIWAYAT</button>
    <button class="nav-item" onclick="nav('laporan', this)">üìä LAPORAN</button>
    <button class="nav-item" onclick="nav('opsi', this)">‚öôÔ∏è OPSI</button>
</nav>

<script>
    let db_trx = JSON.parse(localStorage.getItem('db_v20_trx')) || [];
    let db_biaya = JSON.parse(localStorage.getItem('db_v20_biaya')) || [];

    window.onload = () => {
        document.getElementById('tgl-info').innerText = new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
        updateDashboard();
        renderBiaya();
    };

    function nav(s, el) {
        document.querySelectorAll('.tab').forEach(x => x.style.display = 'none');
        document.getElementById('tab-' + s).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        if(s === 'riwayat') renderRiwayat();
    }

    function hitung() {
        const t = (Number(document.getElementById('berat').value) || 0) * (Number(document.getElementById('harga').value) || 0);
        document.getElementById('total-display').innerText = "Rp " + t.toLocaleString();
    }

    function updateDashboard() {
        const h = new Date().toISOString().slice(0,10);
        const o = db_trx.filter(x => x.tgl.startsWith(h)).reduce((a,b) => a + b.total, 0);
        const b = db_biaya.filter(x => x.tgl.startsWith(h)).reduce((a,b) => a + b.nominal, 0);
        document.getElementById('dash-saldo').innerText = "Rp " + (o - b).toLocaleString();
    }

    // --- LOGIKA PRINT PERSIS RT 05 ---
    function panggilCetak(judul, konten) {
        let p = window.open('', '_blank');
        p.document.write(`
            <html><head><title>${judul}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
            </head><body class="p-4 text-center">
                <div class="d-print-none mb-4">
                    <button class="btn btn-primary btn-lg w-100 p-3 fw-bold shadow" onclick="window.print()">KLIK TOMBOL BIRU INI UNTUK CETAK</button>
                    <p class="mt-2 small text-muted">Jika tombol tidak bereaksi, pastikan fitur Print di setting WebIntoApp sudah aktif.</p>
                </div>
                <div class="text-center">
                    <h4>BUMDes MANDIRI</h4>
                    <p class="small">${new Date().toLocaleString()}</p><hr>
                    ${konten}
                    <hr><p class="small">Terima Kasih</p>
                </div>
            </body></html>
        `);
        p.document.close();
    }

    function simpanTrx() {
        const adm = document.getElementById('admin').value;
        const kg = Number(document.getElementById('berat').value);
        const hrg = Number(document.getElementById('harga').value);
        if(!adm || !kg) return alert("Isi Data!");

        const item = { id: Date.now(), tgl: new Date().toISOString(), adm, kg, hrg, total: kg * hrg };
        db_trx.push(item);
        localStorage.setItem('db_v20_trx', JSON.stringify(db_trx));

        const nota = `
            <div class="text-start d-inline-block w-100">
                <p class="mb-1"><b>Admin:</b> ${item.adm}</p>
                <p class="mb-1"><b>Rincian:</b> ${item.kg} Kg x Rp ${item.hrg.toLocaleString()}</p>
            </div>
            <h2 class="my-4">TOTAL: Rp ${item.total.toLocaleString()}</h2>
        `;
        panggilCetak("Nota Transaksi", nota);
        document.getElementById('berat').value = ""; hitung(); updateDashboard();
    }

    function simpanBiaya() {
        const ket = document.getElementById('ket-biaya').value;
        const nom = Number(document.getElementById('nom-biaya').value);
        if(!nom) return alert("Isi nominal!");
        db_biaya.push({ id: Date.now(), tgl: new Date().toISOString(), ket, nominal: nom });
        localStorage.setItem('db_v20_biaya', JSON.stringify(db_biaya));
        document.getElementById('ket-biaya').value = ""; document.getElementById('nom-biaya').value = "";
        renderBiaya(); updateDashboard();
    }

    function renderBiaya() {
        document.getElementById('list-biaya-full').innerHTML = db_biaya.slice().reverse().map(b => `
            <div class="app-card d-flex justify-content-between align-items-center py-2 border-end border-danger border-4">
                <div><b class="text-uppercase small">${b.ket}</b><br><small class="text-muted">${b.tgl.slice(0,10)}</small></div>
                <b class="text-danger">Rp ${b.nominal.toLocaleString()}</b>
            </div>`).join('') || '<p class="text-center small py-3">Belum ada pengeluaran</p>';
    }

    function renderRiwayat() {
        document.getElementById('list-riwayat').innerHTML = db_trx.slice().reverse().map(x => `
            <div class="app-card border-bottom">
                <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2">
                    <div><b class="text-uppercase small text-dark">${x.adm}</b><br><small class="text-muted">${x.tgl.replace('T',' ').slice(0,16)}</small></div>
                    <b class="text-primary">Rp ${x.total.toLocaleString()}</b>
                </div>
                <div class="d-flex justify-content-between small fw-bold text-secondary">
                    <span>${x.kg} Kg</span>
                    <span>@ Rp ${x.hrg.toLocaleString()}</span>
                </div>
            </div>`).join('') || '<p class="text-center small py-5">Kosong</p>';
    }

    function updateLaporan() {
        const d = document.getElementById('tgl-lap').value;
        const m = document.getElementById('bln-lap').value;
        if(d) {
            const o = db_trx.filter(x => x.tgl.startsWith(d)).reduce((a,b)=>a+b.total,0);
            const b = db_biaya.filter(x => x.tgl.startsWith(d)).reduce((a,b)=>a+b.nominal,0);
            document.getElementById('res-harian').innerHTML = `Omzet: Rp ${o.toLocaleString()}<br>Biaya: Rp ${b.toLocaleString()}<br>Laba: Rp ${(o-b).toLocaleString()}`;
        }
        if(m) {
            const oM = db_trx.filter(x => x.tgl.startsWith(m)).reduce((a,b)=>a+b.total,0);
            const bM = db_biaya.filter(x => x.tgl.startsWith(m)).reduce((a,b)=>a+b.nominal,0);
            document.getElementById('res-bulanan').innerHTML = `Omzet: Rp ${oM.toLocaleString()}<br>Biaya: Rp ${bM.toLocaleString()}<br>Laba: Rp ${(oM-bM).toLocaleString()}`;
        }
    }

    function cetakLap(tipe) {
        const isi = (tipe === 'Harian') ? document.getElementById('res-harian').innerHTML : document.getElementById('res-bulanan').innerHTML;
        if(!isi || isi.includes("Pilih")) return alert("Pilih data!");
        panggilCetak("Laporan "+tipe, `<h5 class="mb-3">LAPORAN ${tipe.toUpperCase()}</h5>${isi}`);
    }

    function exportExcel() {
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db_trx), "Transaksi");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db_biaya), "Biaya");
        XLSX.writeFile(wb, "BUMDes_Mandiri.xlsx");
    }

    function importExcel() {
        const f = document.getElementById('file-import').files[0];
        if(!f) return alert("Pilih file!");
        const r = new FileReader();
        r.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            db_trx = XLSX.utils.sheet_to_json(wb.Sheets.Transaksi) || [];
            db_biaya = XLSX.utils.sheet_to_json(wb.Sheets.Biaya) || [];
            localStorage.setItem('db_v20_trx', JSON.stringify(db_trx));
            localStorage.setItem('db_v20_biaya', JSON.stringify(db_biaya));
            alert("Data Berhasil Dimuat!"); location.reload();
        };
        r.readAsArrayBuffer(f);
    }

    function resetData() { if(confirm("Hapus semua?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
