<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BUMDes Mandiri - Full System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; padding-bottom: 90px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tab { display: none; }
        .tab.active { display: block; }
        .nav-bot { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: flex; height: 75px; border-top: 1px solid #e2e8f0; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: #64748b; border: none; background: none; }
        .nav-item.active { color: #2563eb; }
        .nav-item span { font-size: 18px; margin-bottom: 2px; }
        input, select { border: 1px solid #cbd5e1; border-radius: 8px; padding: 12px; width: 100%; font-weight: 600; margin-top: 4px; }
        label { font-size: 10px; font-weight: 800; color: #94a3b8; uppercase; letter-spacing: 0.5px; }
    </style>
</head>
<body>

<div class="bg-[#0f172a] p-6 text-white rounded-b-[25px] mb-4 shadow-xl">
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-xl font-black text-blue-400">BUMDes MANDIRI</h1>
            <p id="tgl-skrg" class="text-[10px] opacity-70 font-bold uppercase"></p>
        </div>
        <div class="text-right">
            <p class="text-[9px] opacity-60 font-bold uppercase">Omzet Hari Ini</p>
            <h5 id="dash-omzet" class="text-xl font-black text-yellow-400">Rp 0</h5>
        </div>
    </div>
</div>

<div class="container mx-auto px-4">
    
    <div id="tab-kasir" class="tab active space-y-4">
        <div class="card space-y-3">
            <div><label>Nama Admin</label><input type="text" id="admin" placeholder="Petugas"></div>
            <div class="grid grid-cols-2 gap-3">
                <div><label>Berat (Kg)</label><input type="number" id="berat" step="0.1" placeholder="0.0" oninput="hitung()"></div>
                <div><label>Harga (Rp)</label><input type="number" id="harga" placeholder="25000" oninput="hitung()"></div>
            </div>
        </div>
        <div class="card bg-blue-600 text-center py-5 shadow-lg">
            <p class="text-[10px] font-bold text-blue-100 uppercase">Total Pembayaran</p>
            <h2 id="total-display" class="text-4xl font-black text-white">Rp 0</h2>
        </div>
        <button onclick="simpanTrx()" class="w-full bg-[#0f172a] text-white py-4 rounded-xl font-black text-lg shadow-lg">SIMPAN & CETAK NOTA</button>
    </div>

    <div id="tab-biaya" class="tab space-y-4">
        <div class="card border-l-8 border-red-500">
            <h6 class="font-bold text-red-600 text-xs mb-3">INPUT PENGELUARAN</h6>
            <div class="space-y-3">
                <div><label>Keterangan</label><input type="text" id="ket-biaya" placeholder="Contoh: Listrik"></div>
                <div><label>Nominal (Rp)</label><input type="number" id="nom-biaya" placeholder="0"></div>
                <button onclick="simpanBiaya()" class="w-full bg-red-600 text-white py-3 rounded-lg font-bold shadow-md">SIMPAN BIAYA</button>
            </div>
        </div>
        <div id="list-biaya-hari-ini" class="space-y-2"></div>
    </div>

    <div id="tab-riwayat" class="tab space-y-3">
        <div class="flex gap-2">
            <input type="text" id="cari" placeholder="Cari admin..." onkeyup="renderRiwayat()" class="flex-1">
        </div>
        <div id="list-riwayat" class="space-y-2"></div>
    </div>

    <div id="tab-laporan" class="tab space-y-4">
        <div class="card border-t-4 border-slate-900">
            <h6 class="font-bold text-xs mb-2">LAPORAN HARIAN</h6>
            <input type="date" id="tgl-lap" onchange="updateLaporan()">
            <div id="res-harian" class="mt-3 p-3 bg-slate-50 rounded font-bold text-sm border"></div>
            <button onclick="cetakLaporan('Harian')" class="mt-2 w-full bg-slate-800 text-white py-2 rounded font-bold text-[10px] uppercase">Cetak Laporan Harian</button>
        </div>
        <div class="card border-t-4 border-blue-600">
            <h6 class="font-bold text-xs mb-2 text-blue-600">PEMBUKUAN BULANAN</h6>
            <input type="month" id="bln-lap" onchange="updateLaporan()">
            <div id="res-bulanan" class="mt-3 p-3 bg-blue-50 rounded font-bold text-sm border border-blue-100 text-blue-800"></div>
            <button onclick="cetakLaporan('Bulanan')" class="mt-2 w-full bg-blue-600 text-white py-2 rounded font-bold text-[10px] uppercase">Cetak Laporan Bulanan</button>
        </div>
    </div>

    <div id="tab-opsi" class="tab space-y-4">
        <div class="card">
            <button onclick="exportExcel()" class="w-full bg-green-600 text-white py-4 rounded-lg font-bold shadow-md">DOWNLOAD BACKUP EXCEL</button>
            <div class="border-t mt-6 pt-4 border-dashed">
                <label class="block mb-2 text-center text-slate-500 font-bold">IMPORT / RESTORE DATA</label>
                <input type="file" id="file-import" class="text-xs mb-3 border-none p-0">
                <button onclick="importExcel()" class="w-full bg-slate-100 text-slate-600 py-3 rounded-lg font-bold text-xs">GABUNGKAN DATA</button>
            </div>
        </div>
        <button onclick="resetData()" class="w-full text-red-400 text-[10px] font-bold uppercase opacity-30 mt-10">Reset Database Aplikasi</button>
    </div>

</div>

<nav class="nav-bot">
    <button class="nav-item active" onclick="nav('kasir', this)"><span>üõí</span>KASIR</button>
    <button class="nav-item" onclick="nav('biaya', this)"><span>üí∏</span>BIAYA</button>
    <button class="nav-item" onclick="nav('riwayat', this)"><span>üìã</span>RIWAYAT</button>
    <button class="nav-item" onclick="nav('laporan', this)"><span>üìä</span>LAPORAN</button>
    <button class="nav-item" onclick="nav('opsi', this)"><span>‚öôÔ∏è</span>OPSI</button>
</nav>

<script>
    // Database menggunakan nama yang konsisten agar data Bapak aman
    let db_trx = JSON.parse(localStorage.getItem('db_v12_trx')) || [];
    let db_biaya = JSON.parse(localStorage.getItem('db_v12_biaya')) || [];

    window.onload = () => {
        document.getElementById('tgl-skrg').innerText = new Date().toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
        updateDashboard();
    };

    function nav(s, el) {
        document.querySelectorAll('.tab').forEach(x => x.style.display = 'none');
        document.getElementById('tab-' + s).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        if(s === 'riwayat') renderRiwayat();
    }

    function hitung() {
        const t = (Number(document.getElementById('berat').value) || 0) * (Number(document.getElementById('harga').value) || 0);
        document.getElementById('total-display').innerText = "Rp " + t.toLocaleString('id-ID');
    }

    function updateDashboard() {
        const h = new Date().toISOString().slice(0,10);
        const o = db_trx.filter(x => x.tgl.startsWith(h)).reduce((a,b) => a + b.total, 0);
        document.getElementById('dash-omzet').innerText = "Rp " + o.toLocaleString('id-ID');
    }

    function simpanTrx() {
        const adm = document.getElementById('admin').value;
        const kg = Number(document.getElementById('berat').value);
        const hrg = Number(document.getElementById('harga').value);
        if(!adm || !kg) return alert("Data tidak lengkap!");

        const item = { id: Date.now(), tgl: new Date().toISOString(), adm, kg, hrg, total: kg * hrg };
        db_trx.push(item);
        localStorage.setItem('db_v12_trx', JSON.stringify(db_trx));

        // METODE CETAK ALA RT 05 (Aman untuk WebIntoApp)
        let p = window.open('', '_blank');
        p.document.write(`
            <html><head><title>Nota</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></head>
            <body class="p-4 text-center">
                <div class="d-print-none mb-4">
                    <button class="btn btn-primary w-100 p-3 fw-bold" onclick="window.print()">KLIK TOMBOL INI UNTUK PRINT</button>
                </div>
                <h4 class="mb-0">BUMDes MANDIRI</h4>
                <small>${new Date().toLocaleString()}</small><hr>
                <div class="text-start mb-3">
                    <p class="mb-1"><b>Admin:</b> ${item.adm}</p>
                    <p class="mb-1"><b>Item:</b> ${item.kg}kg x Rp ${item.hrg.toLocaleString()}</p>
                </div>
                <h2 class="my-4">Rp ${item.total.toLocaleString()}</h2><hr>
                <p class="small text-muted">Terima Kasih</p>
            </body></html>
        `);
        p.document.close();

        document.getElementById('berat').value = ""; hitung();
        updateDashboard();
    }

    function simpanBiaya() {
        const ket = document.getElementById('ket-biaya').value;
        const nom = Number(document.getElementById('nom-biaya').value);
        if(!nom) return alert("Masukkan nominal!");
        db_biaya.push({ id: Date.now(), tgl: new Date().toISOString(), ket, nominal: nom });
        localStorage.setItem('db_v12_biaya', JSON.stringify(db_biaya));
        alert("Pengeluaran Disimpan");
        document.getElementById('ket-biaya').value = ""; document.getElementById('nom-biaya').value = "";
        updateDashboard();
    }

    function renderRiwayat() {
        const f = document.getElementById('cari').value.toLowerCase();
        document.getElementById('list-riwayat').innerHTML = db_trx.slice().reverse()
            .filter(x => x.adm.toLowerCase().includes(f))
            .map(x => `<div class="card flex justify-between items-center py-3">
                <div><b class="text-sm uppercase">${x.adm}</b><br><small class="text-slate-400">${x.tgl.slice(0,10)} | ${x.kg}kg</small></div>
                <b class="text-blue-600">Rp ${x.total.toLocaleString()}</b>
            </div>`).join('');
    }

    function updateLaporan() {
        const d = document.getElementById('tgl-lap').value;
        const m = document.getElementById('bln-lap').value;
        if(d) {
            const o = db_trx.filter(x => x.tgl.startsWith(d)).reduce((a,b)=>a+b.total,0);
            const b = db_biaya.filter(x => x.tgl.startsWith(d)).reduce((a,b)=>a+b.nominal,0);
            document.getElementById('res-harian').innerHTML = `Omzet: Rp ${o.toLocaleString()}<br>Biaya: Rp ${b.toLocaleString()}<br>Laba: Rp ${(o-b).toLocaleString()}`;
        }
        if(m) {
            const oM = db_trx.filter(x => x.tgl.startsWith(m)).reduce((a,b)=>a+b.total,0);
            const bM = db_biaya.filter(x => x.tgl.startsWith(m)).reduce((a,b)=>a+b.nominal,0);
            document.getElementById('res-bulanan').innerHTML = `Omzet: Rp ${oM.toLocaleString()}<br>Biaya: Rp ${bM.toLocaleString()}<br>Laba Bersih: Rp ${(oM-bM).toLocaleString()}`;
        }
    }

    function cetakLaporan(tipe) {
        const isi = (tipe === 'Harian') ? document.getElementById('res-harian').innerHTML : document.getElementById('res-bulanan').innerHTML;
        if(!isi) return alert("Pilih waktu laporan!");
        let p = window.open('', '_blank');
        p.document.write(`<html><head><title>Laporan</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></head>
        <body class="p-5">
            <div class="d-print-none mb-4"><button class="btn btn-primary w-100" onclick="window.print()">CETAK</button></div>
            <center><h4>LAPORAN ${tipe.toUpperCase()}</h4><hr>${isi}</center>
        </body></html>`);
        p.document.close();
    }

    function exportExcel() {
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db_trx), "Transaksi");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db_biaya), "Biaya");
        XLSX.writeFile(wb, "Backup_BUMDes_Mandiri.xlsx");
    }

    function importExcel() {
        const f = document.getElementById('file-import').files[0];
        if(!f) return alert("Pilih file excel!");
        const r = new FileReader();
        r.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            db_trx = XLSX.utils.sheet_to_json(wb.Sheets.Transaksi);
            db_biaya = XLSX.utils.sheet_to_json(wb.Sheets.Biaya);
            localStorage.setItem('db_v12_trx', JSON.stringify(db_trx));
            localStorage.setItem('db_v12_biaya', JSON.stringify(db_biaya));
            alert("Data Berhasil Dimuat!"); location.reload();
        };
        r.readAsArrayBuffer(f);
    }

    function resetData() { if(confirm("Hapus semua database?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>
