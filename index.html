<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Penjualan Telur ‚Äì Bumdes Campurejo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    .tab-content { display: none; }
    .active-tab { display: block; }
  </style>
</head>

<body class="bg-gray-100 font-sans text-gray-900">
<div class="max-w-6xl mx-auto p-4">
  <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
      <div>
        <h1 class="text-2xl font-black text-gray-800 tracking-tight">ü•ö BUMDES CAMPUREJO</h1>
        <p class="text-[10px] text-green-600 uppercase tracking-[0.2em] font-bold">Sukses Mandiri</p>
      </div>
      <nav class="flex flex-wrap justify-center gap-2 mt-4 md:mt-0 bg-gray-100 p-1 rounded-xl">
          <button onclick="showTab('transaksi')" class="px-4 py-2 hover:bg-white rounded-lg text-xs font-bold transition-all">Input</button>
          <button onclick="showTab('pengeluaran')" class="px-4 py-2 hover:bg-white rounded-lg text-xs font-bold transition-all">Biaya</button>
          <button onclick="showTab('riwayat')" class="px-4 py-2 hover:bg-white rounded-lg text-xs font-bold transition-all">Riwayat</button>
          <button onclick="showTab('laporan')" class="px-4 py-2 hover:bg-white rounded-lg text-xs font-bold transition-all">Laporan</button>
          <button onclick="showTab('pengaturan')" class="px-4 py-2 hover:bg-white rounded-lg text-xs font-bold transition-all">‚öôÔ∏è Setting</button>
      </nav>
  </div>

  <div id="transaksi" class="tab-content active-tab">
    <div class="bg-green-600 p-6 rounded-2xl shadow-lg mb-6 text-white flex justify-between items-center">
        <div>
            <p class="text-xs font-bold uppercase opacity-80">Omzet Penjualan Hari Ini</p>
            <h2 id="todayOmzetDisplay" class="text-3xl font-black">Rp 0</h2>
        </div>
        <div class="text-right text-[10px] font-bold opacity-80" id="todayDateDisplay"></div>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
      <h2 id="formTitle" class="text-xl font-bold mb-6 text-gray-700 border-l-4 border-green-500 pl-4">Transaksi Baru</h2>
      <form id="salesForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <input id="customerName" required placeholder="Nama Pembeli" class="bg-gray-50 border-2 border-transparent focus:border-green-500 p-3 rounded-xl outline-none">
        <input id="staffName" required placeholder="Petugas" class="bg-gray-50 border-2 border-transparent focus:border-green-500 p-3 rounded-xl outline-none">
        <input id="eggWeight" type="number" step="0.01" required placeholder="Berat (kg)" class="bg-gray-50 border-2 border-transparent focus:border-green-500 p-3 rounded-xl outline-none font-bold text-lg">
        <input id="pricePerKg" type="number" required placeholder="Harga per kg" class="bg-gray-50 border-2 border-transparent focus:border-green-500 p-3 rounded-xl outline-none font-bold text-lg">
        <div class="md:col-span-2 bg-green-50 p-6 rounded-2xl border-2 border-green-100 text-center">
            <span class="text-xs font-bold text-green-600 uppercase block mb-1 tracking-widest">Total Bayar</span>
            <input id="totalAmount" readonly class="bg-transparent text-4xl font-black text-green-700 text-center w-full outline-none">
        </div>
        <button type="submit" class="md:col-span-2 bg-green-600 hover:bg-green-700 text-white p-4 rounded-xl font-black shadow-lg transition-all active:scale-95">üíæ SIMPAN & CETAK STRUK</button>
      </form>
    </div>
  </div>

  <div id="pengeluaran" class="tab-content">
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100">
      <h2 class="text-xl font-bold mb-6 text-gray-700 border-l-4 border-red-500 pl-4">Catat Pengeluaran</h2>
      <form id="expenseForm" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
        <input id="expenseName" required placeholder="Keterangan Biaya" class="bg-gray-50 border-2 border-transparent focus:border-red-500 p-3 rounded-xl outline-none">
        <input id="expenseAmount" type="number" required placeholder="Jumlah (Rp)" class="bg-gray-50 border-2 border-transparent focus:border-red-500 p-3 rounded-xl outline-none font-bold">
        <button type="submit" class="md:col-span-2 bg-red-500 hover:bg-red-600 text-white p-3 rounded-xl font-black">Tambah Pengeluaran</button>
      </form>
      <div class="overflow-x-auto"><table class="w-full text-left text-sm"><tbody id="expenseTableBody"></tbody></table></div>
    </div>
  </div>

  <div id="riwayat" class="tab-content">
    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
      <h2 class="text-lg font-bold mb-4">üìú Riwayat Penjualan</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-left text-sm">
          <thead class="bg-gray-50 text-gray-500 uppercase text-[10px] font-bold">
            <tr><th class="p-4 border-b">Tgl</th><th class="p-4 border-b">Pembeli</th><th class="p-4 border-b text-right">Total</th><th class="p-4 border-b text-center">Aksi</th></tr>
          </thead>
          <tbody id="historyTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="laporan" class="tab-content">
    <div class="bg-white p-6 rounded-2xl shadow-xl mb-6 border border-gray-100">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h2 class="text-lg font-black">üìä Laporan Kas Bulanan</h2>
            <button onclick="exportKasPDF()" class="text-[10px] bg-gray-800 text-white px-3 py-1 rounded font-bold uppercase">Cetak PDF Kas</button>
        </div>
        <div class="overflow-x-auto">
            <table id="tableKas" class="w-full text-sm">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 text-[10px] uppercase font-bold text-left">
                        <th class="p-3 border-b">Periode</th>
                        <th class="p-3 border-b text-right">Saldo Awal</th>
                        <th class="p-3 border-b text-right">Penjualan (+)</th>
                        <th class="p-3 border-b text-right">Biaya (-)</th>
                        <th class="p-3 border-b text-right font-bold text-gray-900">Saldo Akhir</th>
                    </tr>
                </thead>
                <tbody id="financialReportBody"></tbody>
            </table>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-green-500">
            <h3 class="font-bold mb-2 text-sm">PDF Harian</h3>
            <input type="date" id="reportDate" class="w-full border p-2 mb-3 rounded-lg text-sm">
            <button onclick="generatePDF('harian')" class="w-full bg-green-600 text-white p-3 rounded-xl font-bold">Download</button>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-blue-500 text-center">
            <h3 class="font-bold mb-2 text-sm">PDF Mingguan</h3>
            <button onclick="generatePDF('mingguan')" class="w-full bg-blue-600 text-white p-3 rounded-xl font-bold mt-10">Download</button>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-lg border-t-4 border-purple-500 text-center">
            <h3 class="font-bold mb-2 text-sm">PDF Bulanan</h3>
            <button onclick="generatePDF('bulanan')" class="w-full bg-purple-600 text-white p-3 rounded-xl font-bold mt-10">Download</button>
        </div>
    </div>
  </div>

  <div id="pengaturan" class="tab-content">
    <div class="bg-white p-8 rounded-2xl shadow-xl border border-gray-100 max-w-md mx-auto">
      <h2 class="text-lg font-bold mb-6 text-center text-gray-700 border-b pb-4 italic">‚öôÔ∏è Manajemen Data</h2>
      <div class="space-y-4 text-center">
          <button onclick="exportData()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-black">üì§ BACKUP DATA (.JSON)</button>
          <input type="file" id="importFile" accept=".json" class="hidden" onchange="importData(event)">
          <button onclick="document.getElementById('importFile').click()" class="w-full bg-orange-500 text-white p-4 rounded-xl font-black">üì• IMPORT DATA</button>
          <button onclick="resetData()" class="w-full bg-red-50 text-red-600 p-4 rounded-xl font-black border-2 border-red-100">‚ö†Ô∏è RESET SEMUA DATA</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- LOGIKA DATABASE ---
let transactions = JSON.parse(localStorage.getItem('eggTransactions')) || [];
let expenses = JSON.parse(localStorage.getItem('eggExpenses')) || [];
let editId = null;

function saveAll() {
    localStorage.setItem('eggTransactions', JSON.stringify(transactions));
    localStorage.setItem('eggExpenses', JSON.stringify(expenses));
}

// --- DASHBOARD & INPUT ---
function updateDashboard() {
    const today = new Date().toISOString().split('T')[0];
    const todayTotal = transactions.filter(t => t.isoDate === today).reduce((sum, t) => sum + t.total, 0);
    document.getElementById('todayOmzetDisplay').innerText = 'Rp ' + todayTotal.toLocaleString('id-ID');
    document.getElementById('todayDateDisplay').innerText = new Date().toLocaleDateString('id-ID');
}

const wInput = document.getElementById('eggWeight');
const pInput = document.getElementById('pricePerKg');
[wInput, pInput].forEach(el => {
    el.addEventListener('input', () => {
        const t = (parseFloat(wInput.value) || 0) * (parseFloat(pInput.value) || 0);
        document.getElementById('totalAmount').value = 'Rp ' + t.toLocaleString('id-ID');
    });
});

document.getElementById('salesForm').addEventListener('submit', (e) => {
    e.preventDefault();
    if(editId) { transactions = transactions.filter(t => t.id !== editId); editId = null; }
    const now = new Date();
    const trx = {
        id: Date.now(),
        notaNo: 'INV'+Math.floor(1000+Math.random()*9000),
        date: now.toLocaleDateString('id-ID'),
        isoDate: now.toISOString().split('T')[0],
        time: now.toLocaleTimeString('id-ID').replace(/:/g, '.'),
        customer: document.getElementById('customerName').value,
        staff: document.getElementById('staffName').value,
        weight: parseFloat(wInput.value),
        price: parseFloat(pInput.value),
        total: parseFloat(wInput.value) * parseFloat(pInput.value)
    };
    transactions.push(trx);
    saveAll(); printRawBT(trx); e.target.reset(); document.getElementById('totalAmount').value = '';
    updateDashboard();
});

document.getElementById('expenseForm').addEventListener('submit', (e) => {
    e.preventDefault();
    const exp = {
        id: Date.now(),
        date: new Date().toLocaleDateString('id-ID'),
        isoDate: new Date().toISOString().split('T')[0],
        name: document.getElementById('expenseName').value,
        amount: parseFloat(document.getElementById('expenseAmount').value)
    };
    expenses.push(exp); saveAll(); e.target.reset(); updateExpenseTable();
});

// --- NAVIGATION ---
function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active-tab'));
    document.getElementById(tabId).classList.add('active-tab');
    if(tabId === 'riwayat') updateHistoryTable();
    if(tabId === 'pengeluaran') updateExpenseTable();
    if(tabId === 'laporan') updateFinancialReport();
    updateDashboard();
}

// --- TABLES ---
function updateHistoryTable() {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = '';
    transactions.slice().reverse().forEach(t => {
        tbody.innerHTML += `<tr class="border-b text-xs"><td class="p-4">${t.date}</td><td class="p-4 font-bold">${t.customer}</td><td class="p-4 text-right font-bold text-green-700">Rp ${t.total.toLocaleString('id-ID')}</td><td class="p-4 flex gap-1 justify-center"><button onclick='printRawBT(${JSON.stringify(t)})' class="bg-blue-600 text-white px-2 py-1 rounded text-[10px]">STRUK</button><button onclick='editTrx(${t.id})' class="bg-orange-500 text-white px-2 py-1 rounded text-[10px]">EDIT</button><button onclick='delTrx(${t.id})' class="bg-red-500 text-white px-2 py-1 rounded text-[10px]">HAPUS</button></td></tr>`;
    });
}

function updateExpenseTable() {
    const tbody = document.getElementById('expenseTableBody');
    tbody.innerHTML = '';
    expenses.slice().reverse().forEach(e => {
        tbody.innerHTML += `<tr class="border-b text-xs"><td class="p-3">${e.date}</td><td class="p-3 font-medium">${e.name}</td><td class="p-3 text-right font-bold text-red-600">Rp ${e.amount.toLocaleString('id-ID')}</td><td class="p-3 text-center"><button onclick="delExp(${e.id})" class="text-red-400 font-bold text-[10px]">HAPUS</button></td></tr>`;
    });
}

function updateFinancialReport() {
    const tbody = document.getElementById('financialReportBody');
    tbody.innerHTML = '';
    const monthly = {};
    transactions.forEach(t => {
        const month = t.isoDate.substring(0, 7);
        if(!monthly[month]) monthly[month] = { in: 0, out: 0 };
        monthly[month].in += t.total;
    });
    expenses.forEach(e => {
        const month = e.isoDate.substring(0, 7);
        if(!monthly[month]) monthly[month] = { in: 0, out: 0 };
        monthly[month].out += e.amount;
    });
    const sorted = Object.keys(monthly).sort();
    let currentSaldo = 0;
    if(sorted.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-400">Belum ada data.</td></tr>'; return; }
    sorted.forEach(m => {
        const sAwal = currentSaldo;
        const sAkhir = sAwal + monthly[m].in - monthly[m].out;
        tbody.innerHTML += `<tr class="border-b text-xs"><td class="p-3 font-bold">${m}</td><td class="p-3 text-right">Rp ${sAwal.toLocaleString('id-ID')}</td><td class="p-3 text-right text-green-600">+${monthly[m].in.toLocaleString('id-ID')}</td><td class="p-3 text-right text-red-500">-${monthly[m].out.toLocaleString('id-ID')}</td><td class="p-3 text-right font-black bg-green-50">Rp ${sAkhir.toLocaleString('id-ID')}</td></tr>`;
        currentSaldo = sAkhir;
    });
}

// --- PDF GENERATION ---
function generatePDF(tipe) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let data = [];
    let title = "";
    if(tipe === 'harian') {
        const d = document.getElementById('reportDate').value;
        if(!d) return alert("Pilih tanggal!");
        data = transactions.filter(t => t.isoDate === d);
        title = "LAPORAN HARIAN: " + d;
    } else if(tipe === 'mingguan') {
        const limit = new Date(new Date().setDate(new Date().getDate() - 7)).toISOString().split('T')[0];
        data = transactions.filter(t => t.isoDate >= limit);
        title = "LAPORAN MINGGUAN (7 HARI)";
    } else if(tipe === 'bulanan') {
        const m = new Date().toISOString().substring(0, 7);
        data = transactions.filter(t => t.isoDate.startsWith(m));
        title = "LAPORAN BULANAN";
    }
    if(data.length === 0) return alert("Data tidak ditemukan.");
    
    const totalOmzet = data.reduce((sum, item) => sum + item.total, 0);
    doc.text("BUMDES CAMPUREJO", 105, 15, { align: "center" });
    doc.text(title, 105, 22, { align: "center" });
    
    const rows = data.map(t => [t.date, t.customer, t.weight+' kg', 'Rp '+t.total.toLocaleString('id-ID')]);
    rows.push(['', '', 'TOTAL', 'Rp ' + totalOmzet.toLocaleString('id-ID')]);

    doc.autoTable({ 
        head: [['Tgl', 'Pelanggan', 'Berat', 'Subtotal']], 
        body: rows, 
        startY: 30,
        didParseCell: function (data) {
            if (data.row.index === rows.length - 1) { data.cell.styles.fontStyle = 'bold'; data.cell.styles.fillColor = [240, 240, 240]; }
        }
    });
    doc.save(`Laporan_${tipe}.pdf`);
}

function exportKasPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("LAPORAN KAS - BUMDES CAMPUREJO", 105, 15, { align: "center" });
    doc.autoTable({ html: '#tableKas', startY: 25 });
    doc.save("Laporan_Kas.pdf");
}

// --- PENYEMPURNAAN IMPORT (FIXED) ---
function importData(e) {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(f) {
        try {
            const rawData = JSON.parse(f.target.result);
            
            // Logika Cerdas: Cek apakah format file gabungan atau hanya daftar transaksi
            if (Array.isArray(rawData)) {
                // Jika file berupa array (seperti file backup_kasir_telur.json Anda)
                transactions = rawData;
                expenses = []; // Reset biaya karena tidak ada di file
            } else {
                // Jika file berupa objek gabungan {transactions, expenses}
                transactions = rawData.transactions || [];
                expenses = rawData.expenses || [];
            }
            
            saveAll();
            alert("‚úÖ Berhasil! " + transactions.length + " data transaksi telah dimuat.");
            location.reload();
        } catch(err) {
            alert("‚ùå Gagal membaca file. Pastikan format file .json benar.");
            console.error(err);
        }
    };
    reader.readAsText(file);
}

function exportData() {
    const blob = new Blob([JSON.stringify({transactions, expenses})], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'backup_bumdes_' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
}

// --- OTHERS ---
function editTrx(id) {
    const t = transactions.find(i => i.id === id);
    if(t) {
        editId = t.id;
        document.getElementById('customerName').value = t.customer;
        document.getElementById('staffName').value = t.staff;
        document.getElementById('eggWeight').value = t.weight;
        document.getElementById('pricePerKg').value = t.price;
        document.getElementById('formTitle').innerText = "Edit Transaksi";
        showTab('transaksi');
    }
}
function delTrx(id) { if(confirm("Hapus?")) { transactions = transactions.filter(t => t.id !== id); saveAll(); updateHistoryTable(); updateDashboard(); } }
function delExp(id) { if(confirm("Hapus?")) { expenses = expenses.filter(e => e.id !== id); saveAll(); updateExpenseTable(); } }
function resetData() { if(confirm('Hapus semua data?')) { localStorage.clear(); location.reload(); } }

function printRawBT(t) {
    let s = `------------------------------\n       BUMDES CAMPUREJO       \n        SUKSES MANDIRI        \n------------------------------\nNota  : ${t.notaNo}\nTgl   : ${t.date} ${t.time}\nPlgn  : ${t.customer}\n------------------------------\nTelur : ${t.weight}kg\nTotal : Rp ${t.total.toLocaleString('id-ID')}\n------------------------------\n   Terima Kasih\n\n\n\n`;
    window.location.href = "rawbt:base64," + btoa(s);
}

// Init
updateDashboard();
</script>
</body>
</html>
