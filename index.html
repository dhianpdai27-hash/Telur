<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Telur BUMDes Pro PDF</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-size: 1.15rem; }
        .tab { display: none; }
        .tab.active { display: block; }
        input, select { font-size: 1.2rem !important; padding: 14px !important; }
        button { font-weight: bold; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 15px; }
    </style>
</head>

<body class="bg-blue-50 pb-24">

<div class="bg-blue-800 text-white p-6 text-center shadow-lg mb-4">
    <h1 class="text-2xl font-bold uppercase tracking-wide">ðŸ¥š Kasir Telur BUMDes</h1>
</div>

<div class="fixed bottom-0 left-0 right-0 bg-white border-t flex flex-wrap shadow-[0_-2px_15px_rgba(0,0,0,0.15)] z-50">
    <button onclick="openTab('kasir')" class="flex-1 p-4 text-xs border-r">KASIR</button>
    <button onclick="openTab('biaya')" class="flex-1 p-4 text-xs border-r">BIAYA</button>
    <button onclick="openTab('riwayat')" class="flex-1 p-4 text-xs border-r">RIWAYAT</button>
    <button onclick="openTab('laporan')" class="flex-1 p-4 text-xs border-r">LAPORAN</button>
    <button onclick="openTab('setting')" class="flex-1 p-4 text-xs text-red-600">OPSI</button>
</div>

<div class="max-w-xl mx-auto p-4">

    <div id="tab-kasir" class="tab active space-y-4">
        <div class="card">
            <label class="block mb-1 font-semibold">Nama Admin</label>
            <input id="admin" placeholder="Ketik nama admin..." class="border-2 border-blue-200 rounded-lg w-full mb-3">
            
            <label class="block mb-1 font-semibold">Data Penjualan</label>
            <div class="grid grid-cols-2 gap-3">
                <input id="berat" type="number" step="0.1" placeholder="Kg" class="border-2 border-blue-200 rounded-lg w-full" oninput="hitungTotal()">
                <input id="harga" type="number" placeholder="Harga/Kg" class="border-2 border-blue-200 rounded-lg w-full" oninput="hitungTotal()">
            </div>
        </div>
        
        <div class="bg-yellow-100 border-2 border-yellow-400 p-6 text-center rounded-xl">
            <p class="text-sm font-bold text-yellow-700 uppercase">Total Bayar</p>
            <div id="totalDisplay" class="text-4xl font-black text-blue-900">Rp 0</div>
        </div>

        <button onclick="simpanTrx()" class="bg-blue-600 hover:bg-blue-700 text-white p-6 w-full rounded-2xl shadow-xl text-xl">
            SIMPAN & CETAK PDF
        </button>
    </div>

    <div id="tab-biaya" class="tab space-y-4">
        <div class="card border-l-8 border-red-500">
            <h2 class="text-xl font-bold text-red-700 mb-4">Input Pengeluaran</h2>
            <input id="ketBiaya" placeholder="Keterangan (ex: Listrik, Pakan)" class="border-2 border-gray-200 rounded-lg w-full mb-3">
            <input id="jumlahBiaya" type="number" placeholder="Nominal Rp" class="border-2 border-gray-200 rounded-lg w-full mb-4">
            <button onclick="simpanBiaya()" class="bg-red-600 text-white p-4 w-full rounded-xl">SIMPAN BIAYA</button>
        </div>
    </div>

    <div id="tab-riwayat" class="tab space-y-4">
        <input id="filterAdmin" placeholder="Cari nama admin..." onkeyup="loadRiwayat()" class="border-2 border-blue-100 p-3 rounded-lg w-full">
        <div class="overflow-x-auto card p-0">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-100 border-b">
                    <tr>
                        <th class="p-3 text-xs">Waktu/Admin</th>
                        <th class="p-3 text-xs text-right">Detail</th>
                        <th class="p-3 text-xs text-right">Total</th>
                    </tr>
                </thead>
                <tbody id="listTrx" class="text-sm"></tbody>
            </table>
        </div>
        <button onclick="downloadRiwayatPDF()" class="bg-green-600 text-white p-4 w-full rounded-xl">DOWNLOAD RIWAYAT (PDF)</button>
    </div>

    <div id="tab-laporan" class="tab space-y-6">
        <div class="card">
            <label class="block mb-2 font-bold uppercase text-gray-500 text-xs">Laporan Harian</label>
            <input type="date" id="tglHarian" class="border-2 border-blue-200 p-3 w-full rounded-lg mb-3" onchange="renderHarian()">
            <div id="hasilHarian" class="space-y-2"></div>
        </div>

        <div class="card">
            <label class="block mb-2 font-bold uppercase text-gray-500 text-xs">Laporan Bulanan</label>
            <input type="month" id="blnBuku" class="border-2 border-blue-200 p-3 w-full rounded-lg mb-3" onchange="renderBulanan()">
            <div id="hasilBuku" class="space-y-2"></div>
        </div>
    </div>

    <div id="tab-setting" class="tab space-y-4">
        <button onclick="exportExcel()" class="card w-full text-center font-bold text-green-700 border-2 border-green-200">BACKUP KE EXCEL</button>
        <div class="card">
            <p class="text-xs mb-2 italic">Import Data Excel:</p>
            <input type="file" id="fileExcel" class="text-xs mb-2">
            <button onclick="importExcel()" class="bg-blue-100 text-blue-700 p-2 w-full rounded">PROSES IMPORT</button>
        </div>
        <button onclick="resetData()" class="bg-red-100 text-red-700 p-5 w-full rounded-2xl font-bold mt-10">HAPUS SEMUA DATA</button>
    </div>

</div>

<script>
    const { jsPDF } = window.jspdf;
    let transaksi = JSON.parse(localStorage.getItem("trx_telur_v2")) || [];
    let biaya = JSON.parse(localStorage.getItem("biaya_telur_v2")) || [];

    function openTab(t) {
        document.querySelectorAll(".tab").forEach(x => x.classList.remove("active"));
        document.getElementById("tab-" + t).classList.add("active");
        if (t === "riwayat") loadRiwayat();
    }

    function hitungTotal() {
        const b = document.getElementById('berat').value || 0;
        const h = document.getElementById('harga').value || 0;
        document.getElementById('totalDisplay').innerText = "Rp " + (b * h).toLocaleString("id-ID");
    }

    function simpanTrx() {
        const b = +document.getElementById('berat').value;
        const h = +document.getElementById('harga').value;
        const adm = document.getElementById('admin').value;

        if (!b || !h || !adm) return alert("Lengkapi Admin, Berat, dan Harga!");

        const data = {
            tgl: new Date().toISOString(),
            admin: adm,
            kg: b,
            harga: h,
            total: b * h
        };

        transaksi.push(data);
        localStorage.setItem("trx_telur_v2", JSON.stringify(transaksi));

        // PDF NOTA (Kertas Struk 80mm)
        const doc = new jsPDF({ unit: 'mm', format: [80, 100] });
        doc.setFont("helvetica", "bold");
        doc.text("BUMDES TELUR", 40, 10, { align: "center" });
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.text(`Tgl: ${new Date().toLocaleString("id-ID")}`, 5, 20);
        doc.text(`Admin: ${data.admin}`, 5, 25);
        doc.text("---------------------------------------------------------", 5, 30);
        doc.text(`${data.kg} Kg x Rp ${data.harga.toLocaleString("id-ID")}`, 5, 38);
        doc.setFontSize(11);
        doc.text(`TOTAL: Rp ${data.total.toLocaleString("id-ID")}`, 5, 48);
        doc.setFontSize(9);
        doc.text("---------------------------------------------------------", 5, 55);
        doc.text("Terima Kasih", 40, 65, { align: "center" });
        
        doc.save(`Nota_${Date.now()}.pdf`);

        document.getElementById('berat').value = "";
        document.getElementById('harga').value = "";
        hitungTotal();
    }

    function simpanBiaya() {
        const ket = document.getElementById('ketBiaya').value;
        const jml = +document.getElementById('jumlahBiaya').value;
        const adm = document.getElementById('admin').value;
        if (!ket || !jml || !adm) return alert("Mohon isi Admin dan Data Biaya!");

        biaya.push({ tgl: new Date().toISOString(), admin: adm, keterangan: ket, total: jml });
        localStorage.setItem("biaya_telur_v2", JSON.stringify(biaya));
        alert("Biaya berhasil dicatat!");
        document.getElementById('ketBiaya').value = "";
        document.getElementById('jumlahBiaya').value = "";
    }

    function loadRiwayat() {
        const filter = document.getElementById('filterAdmin').value.toLowerCase();
        const html = transaksi.slice().reverse()
            .filter(t => t.admin.toLowerCase().includes(filter))
            .map(t => `
                <tr class="border-b">
                    <td class="p-3 text-xs">${new Date(t.tgl).toLocaleDateString("id-ID")}<br><span class="text-blue-600 font-bold">${t.admin}</span></td>
                    <td class="p-3 text-right text-xs">${t.kg}kg<br>@${t.harga.toLocaleString("id-ID")}</td>
                    <td class="p-3 text-right font-bold text-blue-800">Rp ${t.total.toLocaleString("id-ID")}</td>
                </tr>
            `).join("");
        document.getElementById('listTrx').innerHTML = html || "<tr><td colspan='3' class='p-5 text-center'>Data kosong</td></tr>";
    }

    function renderHarian() {
        const tgl = document.getElementById('tglHarian').value;
        if (!tgl) return;
        const fTrx = transaksi.filter(t => t.tgl.startsWith(tgl));
        const fBy = biaya.filter(b => b.tgl.startsWith(tgl));
        const tj = fTrx.reduce((a, b) => a + b.total, 0);
        const tb = fBy.reduce((a, b) => a + b.total, 0);

        document.getElementById('hasilHarian').innerHTML = `
            <div class="flex justify-between text-green-700 border-b pb-2"><span>Pendapatan Kotor:</span><b>Rp ${tj.toLocaleString("id-ID")}</b></div>
            <div class="flex justify-between text-red-600 border-b pb-2"><span>Total Biaya:</span><b>Rp ${tb.toLocaleString("id-ID")}</b></div>
            <div class="p-3 bg-blue-800 text-white rounded-lg flex justify-between mt-2">
                <span class="font-bold">SALDO BERSIH:</span>
                <span class="font-black">Rp ${(tj - tb).toLocaleString("id-ID")}</span>
            </div>
        `;
    }

    function renderBulanan() {
        const bln = document.getElementById('blnBuku').value;
        if (!bln) return;
        const fTrx = transaksi.filter(t => t.tgl.startsWith(bln));
        const fBy = biaya.filter(b => b.tgl.startsWith(bln));
        const tj = fTrx.reduce((a, b) => a + b.total, 0);
        const tb = fBy.reduce((a, b) => a + b.total, 0);

        document.getElementById('hasilBuku').innerHTML = `
            <div class="flex justify-between border-b pb-2"><span>Total Penjualan:</span><b class="text-green-600">Rp ${tj.toLocaleString("id-ID")}</b></div>
            <div class="flex justify-between border-b pb-2"><span>Total Pengeluaran:</span><b class="text-red-600">Rp ${tb.toLocaleString("id-ID")}</b></div>
            <div class="p-4 bg-yellow-400 rounded-xl text-center mt-3">
                <p class="text-[10px] font-bold uppercase">Laba Bersih Bulan Ini</p>
                <h2 class="text-2xl font-black text-yellow-900">Rp ${(tj - tb).toLocaleString("id-ID")}</h2>
            </div>
        `;
    }

    function downloadRiwayatPDF() {
        const doc = new jsPDF();
        doc.text("RIWAYAT PENJUALAN BUMDES", 10, 10);
        let y = 20;
        transaksi.forEach((t, i) => {
            doc.text(`${i+1}. ${new Date(t.tgl).toLocaleDateString()} - ${t.admin}: Rp ${t.total.toLocaleString()}`, 10, y);
            y += 7;
        });
        doc.save("Riwayat_Lengkap.pdf");
    }

    function exportExcel() {
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(transaksi), "Penjualan");
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(biaya), "Biaya");
        XLSX.writeFile(wb, "Data_BUMDES.xlsx");
    }

    function importExcel() {
        const f = document.getElementById('fileExcel').files[0];
        if (!f) return alert("Pilih file!");
        const r = new FileReader();
        r.onload = e => {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
            if (wb.Sheets.Penjualan) {
                transaksi = XLSX.utils.sheet_to_json(wb.Sheets.Penjualan);
                localStorage.setItem("trx_telur_v2", JSON.stringify(transaksi));
            }
            if (wb.Sheets.Biaya) {
                biaya = XLSX.utils.sheet_to_json(wb.Sheets.Biaya);
                localStorage.setItem("biaya_telur_v2", JSON.stringify(biaya));
            }
            alert("Import Berhasil!");
            location.reload();
        };
        r.readAsArrayBuffer(f);
    }

    function resetData() {
        if (confirm("Hapus semua data permanen?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>

</body>
</html>

